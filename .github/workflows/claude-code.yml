name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  # Run tests and lint first
  test-and-lint:
    runs-on: ubuntu-latest
    outputs:
      test_result: ${{ steps.test.outcome }}
      lint_result: ${{ steps.lint.outcome }}
      test_output: ${{ steps.test.outputs.output }}
      lint_output: ${{ steps.lint.outputs.output }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Lint
        id: lint
        continue-on-error: true
        run: |
          npm run lint 2>&1 | tee lint-output.txt
          echo "output<<EOF" >> $GITHUB_OUTPUT
          cat lint-output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Run Tests
        id: test
        continue-on-error: true
        run: |
          npm test 2>&1 | tee test-output.txt
          echo "output<<EOF" >> $GITHUB_OUTPUT
          tail -50 test-output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: test-lint-results
          path: |
            lint-output.txt
            test-output.txt

  # Claude review with test/lint context
  claude-review:
    runs-on: ubuntu-latest
    needs: test-and-lint
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    
    steps:
      - name: Claude Code Review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-20250514
          timeout_minutes: 10
          
          custom_instructions: |
            You are a senior engineering manager reviewing this PR.
            
            ## Test & Lint Status
            - Lint: ${{ needs.test-and-lint.outputs.lint_result }}
            - Tests: ${{ needs.test-and-lint.outputs.test_result }}
            
            ## Review Guidelines
            1. **TypeScript & Type Safety** - Check for type errors, any usage, proper typing
            2. **Test Coverage** - Verify unit tests exist for new functions. If tests failed, explain why.
            3. **Lint Issues** - If lint failed, identify the issues
            4. **Error Handling** - Check for proper try/catch, error boundaries
            5. **Code Organization** - Review modularity and separation of concerns
            6. **Naming Conventions** - Consistent, descriptive names
            7. **Security** - Flag any potential vulnerabilities
            8. **Performance** - Suggest optimizations where appropriate
            
            ## Categorize Findings
            - ðŸ”´ MUST FIX: Critical issues blocking merge
            - ðŸŸ¡ SHOULD FIX: Important improvements (auto-creates issue)
            - ðŸŸ¢ NICE TO HAVE: Optional enhancements (auto-creates issue)
            
            ## Forward Plan
            At the end of your review, always include a "## Forward Plan" section:
            1. List immediate fixes needed before merge
            2. List follow-up tasks for future PRs
            3. Suggest which issues should be created
            4. Note any architectural considerations for future work
            
            Be specific with code examples when suggesting changes.
